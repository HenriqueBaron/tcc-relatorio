%	Estilo desenvolvido por Henrique Baron em 29/01/2018.
%	
%	Formata um documento da classe abnTeX2 para o padrão exigido pela Universidade de Caxias do Sul para
%	trabalhos de conclusão de curso.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Verificação do compilador utilizado
\usepackage{ifluatex}
\ifluatex
	% Se o documento está sendo compilado com LuaLaTeX, altera-se a fonte do modo matemático para ser igual à fonte do texto, e não ser em itálico.
	\usepackage[math-style=upright]{unicode-math}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Inclusão e configuração de pacotes

% Código necessário para evitar conflito no pacote substr pelo uso dele por ambos os pacotes abntex2cite e glossaries
\let\su@ExpandTwoArgs\relax 
\let\IfSubStringInString\relax 
\let\su@IfSubStringInString\relax

\usepackage[nonumberlist,nopostdot,sort=use,style=long,acronym]{glossaries} % Criação da lista de símbolos
\setlength{\glsdescwidth}{\linewidth} % Ajusta a largura da tabela interna da lista de símbolos
\usepackage{etoolbox} % Recursos de programação para LaTeX
\usepackage{indentfirst} % Indenta o primeiro parágrafo de cada seção, o que não é o padrão do LaTeX.
\usepackage[absolute]{textpos}
\usepackage{calc}
\usepackage{amsmath}
\allowdisplaybreaks % Permite quebras de página em displays, como conjuntos de equações.
\usepackage{xparse} % Permite a criação de comandos com mais de um parâmetro opcional.
\usepackage{graphicx} % Inserção de imagens
\usepackage{float} % Posicionamento de caixas flutuantes com a opção "h" (Here)
\usepackage{adjustbox}
\newlength\larguraimagem
\usepackage{chngcntr} % Alteração dos parâmetros de contadores de equações, figuras etc.
\counterwithout{equation}{chapter} % Contagem das equações contínua ao longo do documento

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Configuração das medidas padrão utilizadas no documento
\setlength{\parindent}{1.5cm} % Define o recuo (indentação) da primeira linha do parágrafo.
\setlength{\parskip}{0pt plus 2pt} % Define o espaçamento entre parágrafos.

% Correção do espaçamento após títulos de capítulos
\setlength\afterchapskip{1.5\onelineskip plus 2pt minus 2pt}

% Ajuste do espaçamento para ilustrações
\setlength\belowcaptionskip{6pt} % Espaço abaixo do título da figura/quadro/tabela
\setlength\textfloatsep{14pt plus 4pt minus 2pt} % Espaço entre a ilustração e o texto, acima ou abaixo

% Ajuste do espaçamento antes, depois e entre equações
\AtBeginDocument{\setlength\abovedisplayskip{14pt plus 4pt minus 1pt}}
\AtBeginDocument{\setlength\belowdisplayskip{14pt plus 4pt minus 1pt}}
\setlength\jot{10pt plus 2pt minus 2pt} % Espaço entre equações dos ambientes do pacote amsmath

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Modificações de comandos específicos da classe abnTeX2 para adequar ao padrão da UCS

% Redefinição do estilo abntheadings, que coloca no cabeçalho das páginas o nome do capítulo/seção e uma linha horizontal, além do número de página. O padrão da UCS pede somente o número de página.
\makepagestyle{abntheadings}
\makeevenhead{abntheadings}{\ABNTEXfontereduzida\thepage}{}{}
\makeoddhead{abntheadings}{}{}{\ABNTEXfontereduzida\thepage}

% Nomes de elementos pré-textuais que precisam ser alterados
\addto\captionsbrazil{
	\renewcommand{\listfigurename}{Lista de figuras}
}

% Redefinição de fontes e tamanhos para os capítulos e seções, NO TEXTO
\renewcommand{\ABNTEXchapterfont}{\bfseries}
\renewcommand{\ABNTEXchapterfontsize}{\normalsize}

\renewcommand{\ABNTEXsectionfont}{\ABNTEXchapterfont\mdseries}
\renewcommand{\ABNTEXsectionfontsize}{\normalsize}

\renewcommand{\ABNTEXsubsectionfont}{\ABNTEXsectionfont\bfseries}
\renewcommand{\ABNTEXsubsectionfontsize}{\normalsize}

\renewcommand{\ABNTEXsubsubsectionfont}{\ABNTEXsubsectionfont\mdseries}
\renewcommand{\ABNTEXsubsubsectionfontsize}{\normalsize}

\renewcommand{\ABNTEXsubsubsubsectionfont}{\ABNTEXsubsubsectionfont\itshape}
\renewcommand{\ABNTEXsubsubsubsectionfontsize}{\normalsize}

% Redefinição de fontes e tamanhos para os capítulos e seções, NO SUMÁRIO. Como o guia da UCS solicita que a apresentação dos títulos seja idêntica no sumário e no texto, as fontes declaradas acima são utilizadas, o que não é o padrão da classe abnTeX2.
\renewcommand{\cftchapterfont}{\ABNTEXchapterfont}
\renewcommand{\cftsectionfont}{\ABNTEXsectionfont}
\renewcommand{\cftsubsectionfont}{\ABNTEXsubsectionfont}
\renewcommand{\cftsubsubsectionfont}{\ABNTEXsubsubsectionfont}
\renewcommand{\cftparagraphfont}{\ABNTEXsubsubsubsectionfont}

% Redefinição do comando que monta a capa, para adequar ao padrão solicitado pela UCS
\renewcommand{\imprimircapa}{
	\pdfbookmark[0]{Capa}{Capa}
	\begin{capa}
		% Para colocar em letra maiúscula as informações de autor, título e data, é preciso utilizar o comando nativo do LaTeX - e não os comandos do abnTeX2, porque eles apenas encapsulam comandos nativos do LaTeX, o que faz com que a expansão adiantada pelo \expandafter não funcione.
		\centering
		\expandafter\uppercase\expandafter{\imprimirinstituicao}
		\vfill
		
		% Nome em uma caixa de texto, posicionada da seguinte maneira:
		% largura: largura A4 - margens = 210-30-20 = 160mm
		% posição horizontal: começo da margem esquerda = 30mm
		% posição vertical: altura A4/4 + margem superior / 2 = 294mm/4 + 15mm
		\begin{textblock*}{160mm}(30mm, 297mm/4+15mm)
			\expandafter\uppercase\expandafter{\theauthor}
		\end{textblock*}
		
		% Título em uma caixa de texto, posicionada no centro vertical da folha (297mm/2)
		\begin{textblock*}{160mm}(30mm, 297mm/2)
			\expandafter\uppercase\expandafter{\thetitle}
		\end{textblock*}
		
		\vfill
		
		\expandafter\uppercase\expandafter{\imprimirlocal}\\
		\expandafter\uppercase\expandafter{\thedate}
	\end{capa}
}

% Redefinição do comando que gera o conteúdo da folha de rosto, para adequar ao padrão solicitado pela UCS
\renewcommand{\folhaderostocontent}{
	\centering
	\expandafter\uppercase\expandafter{\theauthor}
	\vfill
	\vfill
	
	% Título em uma caixa de texto, posicionada no centro vertical da folha (297mm/2)
	\begin{textblock*}{160mm}(30mm, 297mm/2)
		\expandafter\uppercase\expandafter{\thetitle}
	\end{textblock*}
	\vspace{10mm}
	
	\abntex@ifnotempty{\imprimirpreambulo}{
		\hspace{.45\textwidth}
		\begin{minipage}{.5\textwidth}
			\mdseries
			\SingleSpacing
			\imprimirpreambulo
			\begin{flushright}
				\imprimirorientadorRotulo~\imprimirorientador
			\end{flushright}
		\end{minipage}
	}
	\vfill
	
	\expandafter\uppercase\expandafter{\imprimirlocal}\\
	\expandafter\uppercase\expandafter{\thedate}	
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Outros comandos %%%

% Código apenas copiado do TeX Stack Exchange: faz com que os nomes das seções no sumário sejam escritos em letra maiúscula.
\let\oldcontentsline\contentsline
\def\contentsline#1#2{%
	\expandafter\ifx\csname l@#1\endcsname\l@section
	\expandafter\@firstoftwo
	\else
	\expandafter\@secondoftwo
	\fi
	{%
		\oldcontentsline{#1}{\MakeTextUppercase{#2}}%
	}{%
		\oldcontentsline{#1}{#2}%
	}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Comandos e ambientes específicos deste pacote

% Imprimir a folha de aprovação segundo os requisitos da UCS
% PARÂMETROS, NA ORDEM:
% 1 - Instituição do convidado externo (opcional). VALOR PADRÃO: Universidade de Caxias do Sul - UCS
% 2 - Data de aprovação, na forma dd/mm/aaaa
% 3 - Nome do primeiro professor da banca (sem ser o orientador)
% 4 - Nome do segundo professor da banca (sem ser o orientador)
% 5 - Nome do professor/convidado externo
\newcommand{\imprimirfolhadeaprovacaoUCS}[5][Universidade de Caxias do Sul - UCS]{
	\begin{folhadeaprovacao}
		\begin{center}
			\bfseries
			\ABNTEXchapterfont
			\expandafter\uppercase\expandafter{\theauthor}
			\vspace{1.5cm}
			
			\expandafter\uppercase\expandafter{\thetitle}
			\vspace{0.5cm}
		\end{center}
		
		\abntex@ifnotempty{\imprimirpreambulo}{
			\hspace{.45\textwidth}
			\begin{minipage}{.5\textwidth}
				\mdseries
				\SingleSpacing
				\imprimirpreambulo
				\begin{flushright}
					\imprimirorientadorRotulo~\imprimirorientador
				\end{flushright}
			\end{minipage}
		}
		\vspace{24pt}
		
		\hspace{.45\textwidth}
		\begin{minipage}{.5\textwidth}
			\bfseries
			Aprovado(a) em #2
		\end{minipage}
		\vspace{3cm}
		
		\noindent\textbf{Banca Examinadora}
		\begin{SingleSpace}
			\vspace*{\ABNTEXsignskip}
			\noindent
			\rule{\ABNTEXsignwidth}{\ABNTEXsignthickness}\\
			Prof. \imprimirorientador\\
			Universidade de Caxias do Sul - UCS \par
			\vspace*{\ABNTEXsignskip}
			\noindent
			\rule{\ABNTEXsignwidth}{\ABNTEXsignthickness}\\
			Prof. #3\\
			Universidade de Caxias do Sul - UCS \par
			\vspace*{\ABNTEXsignskip}
			\noindent
			\rule{\ABNTEXsignwidth}{\ABNTEXsignthickness}\\
			Prof. #4\\
			Universidade de Caxias do Sul - UCS \par
			\vspace*{\ABNTEXsignskip}
			\noindent
			\rule{\ABNTEXsignwidth}{\ABNTEXsignthickness}\\
			#5\\
			#1
		\end{SingleSpace}
	\end{folhadeaprovacao}
}

% Inserção de uma figura com descrição e fonte, atendendo aos requisitos de formatação
% PARÂMETROS, NA ORDEM:
% 1 - Caminho para o arquivo de imagem
% 2 - Título da figura
% 3 - Fonte e ano da figura (texto que fica abaixo)
\newcommand{\incluirimagem}[3]{
	\caption{#2}
	\adjustimage{fbox=1.5pt {\fboxsep} 1pt,gstore width=\larguraimagem, center}{#1} \par
	\centering
	\begin{minipage}[h]{\larguraimagem}
		\raggedright\footnotesize\hspace{3pt} Fonte: #3
	\end{minipage}
}
